<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Controle de Gastos</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-950 text-white p-6">

  <h1 class="text-2xl font-bold mb-6">üí∞ Controle de Gastos</h1>

  <!-- Sal√°rio Fixo -->
  <div class="bg-gray-900 p-4 rounded-2xl shadow-md mb-4">
    <h2 class="text-lg font-semibold mb-2">Sal√°rio Fixo</h2>
    <input id="salario" type="number" placeholder="Digite seu sal√°rio"
           class="w-full p-2 mb-2 rounded bg-gray-800 text-white">
    <button onclick="salvarSalario()"
            class="bg-green-600 w-full py-2 rounded-xl hover:bg-green-700">
      Salvar Sal√°rio
    </button>
  </div>

  <!-- Adicionar Gasto -->
  <div class="bg-gray-900 p-4 rounded-2xl shadow-md mb-4">
    <h2 class="text-lg font-semibold mb-2">Adicionar Gasto</h2>
    <input id="descricao" placeholder="Descri√ß√£o"
           class="w-full p-2 mb-2 rounded bg-gray-800 text-white">
    <input id="valor" type="number" placeholder="Valor"
           class="w-full p-2 mb-2 rounded bg-gray-800 text-white">
    <input id="parcelas" type="number" placeholder="Parcelas (1 se √† vista)"
           class="w-full p-2 mb-2 rounded bg-gray-800 text-white">
    <select id="mes" class="w-full p-2 mb-2 rounded bg-gray-800 text-white">
      <option>Janeiro</option><option>Fevereiro</option><option>Mar√ßo</option>
      <option>Abril</option><option>Maio</option><option>Junho</option>
      <option>Julho</option><option>Agosto</option><option>Setembro</option>
      <option>Outubro</option><option>Novembro</option><option>Dezembro</option>
    </select>
    <button onclick="salvarGasto()"
            class="bg-indigo-600 w-full py-2 rounded-xl hover:bg-indigo-700">
      Salvar Gasto
    </button>
  </div>

  <!-- Hist√≥rico -->
  <div class="bg-gray-900 p-4 rounded-2xl shadow-md mb-4">
    <h2 class="text-lg font-semibold mb-2">Hist√≥rico</h2>
    <ul id="historico" class="space-y-2"></ul>
  </div>

  <!-- Saldo -->
  <div class="bg-gray-900 p-4 rounded-2xl shadow-md mb-4">
    <h2 class="text-lg font-semibold mb-2">Saldo Atual</h2>
    <p id="saldo" class="text-2xl font-bold text-green-400">R$ 0,00</p>
  </div>

  <!-- Gr√°ficos -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <canvas id="graficoCategorias"></canvas>
    <canvas id="graficoMensal"></canvas>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, addDoc, doc, setDoc, getDoc, deleteDoc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // üî• Configura√ß√£o Firebase (coloque a sua aqui)
    const firebaseConfig = {
      apiKey: "AIzaSyCOHtSTxM3uDD_vVurML1gJ1zMZz9YtP9o",
      authDomain: "planilha-gastos-a8665.firebaseapp.com",
      projectId: "planilha-gastos-a8665",
      storageBucket: "planilha-gastos-a8665.firebasestorage.app",
      messagingSenderId: "126522944194",
      appId: "1:126522944194:web:57a15e65b25a2f1216a95b",
      measurementId: "G-09TE1G2RMQ"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let salarioFixo = 0;
    let chart1, chart2;

    // üëâ Salvar sal√°rio
    async function salvarSalario() {
      const valor = parseFloat(document.getElementById("salario").value);
      if (isNaN(valor) || valor <= 0) return alert("Digite um sal√°rio v√°lido");
      const user = auth.currentUser;
      await setDoc(doc(db, "usuarios", user.uid, "config", "salario"), { valor });
      salarioFixo = valor;
      alert("Sal√°rio salvo!");
    }

    // üëâ Carregar sal√°rio salvo
    async function carregarSalario() {
      const user = auth.currentUser;
      const docSnap = await getDoc(doc(db, "usuarios", user.uid, "config", "salario"));
      if (docSnap.exists()) salarioFixo = docSnap.data().valor;
    }

    // üëâ Salvar gasto
    async function salvarGasto() {
      const descricao = document.getElementById("descricao").value;
      const valor = parseFloat(document.getElementById("valor").value);
      const parcelas = parseInt(document.getElementById("parcelas").value) || 1;
      const mes = document.getElementById("mes").value;
      if (!descricao || isNaN(valor) || valor <= 0) return alert("Preencha os campos corretamente");

      const user = auth.currentUser;
      const valorParcela = valor / parcelas;

      for (let i = 0; i < parcelas; i++) {
        await addDoc(collection(db, "usuarios", user.uid, "gastos"), {
          descricao,
          valor: valorParcela,
          mes,
          parcela: `${i+1}/${parcelas}`,
          data: new Date().toISOString()
        });
      }
      document.getElementById("descricao").value = "";
      document.getElementById("valor").value = "";
      document.getElementById("parcelas").value = "";
    }

    // üëâ Remover gasto
    async function removerGasto(id) {
      const user = auth.currentUser;
      await deleteDoc(doc(db, "usuarios", user.uid, "gastos", id));
    }

    // üëâ Listar gastos e atualizar gr√°ficos
    function listarGastos() {
      const user = auth.currentUser;
      const q = query(collection(db, "usuarios", user.uid, "gastos"), orderBy("data", "desc"));
      
      onSnapshot(q, (snapshot) => {
        const historico = document.getElementById("historico");
        historico.innerHTML = "";
        let totalGastos = 0;
        let porMes = {};

        snapshot.forEach(docSnap => {
          const g = docSnap.data();
          totalGastos += g.valor;
          porMes[g.mes] = (porMes[g.mes] || 0) + g.valor;

          const li = document.createElement("li");
          li.className = "flex justify-between bg-gray-800 p-2 rounded";
          li.innerHTML = `
            <span>${g.descricao} - R$${g.valor.toFixed(2)} (${g.parcela}) - ${g.mes}</span>
            <button onclick="removerGasto('${docSnap.id}')" class="text-red-500 hover:text-red-700">üóëÔ∏è</button>
          `;
          historico.appendChild(li);
        });

        // Atualizar saldo
        document.getElementById("saldo").innerText =
          `R$ ${(salarioFixo - totalGastos).toFixed(2)}`;

        // Atualizar gr√°ficos
        atualizarGraficos(porMes, totalGastos);
      });
    }

    // üëâ Gr√°ficos
    function atualizarGraficos(porMes, total) {
      if (chart1) chart1.destroy();
      if (chart2) chart2.destroy();

      chart1 = new Chart(document.getElementById("graficoCategorias"), {
        type: "bar",
        data: {
          labels: Object.keys(porMes),
          datasets: [{ label: "Gastos", data: Object.values(porMes), backgroundColor: "#6366f1" }]
        }
      });

      chart2 = new Chart(document.getElementById("graficoMensal"), {
        type: "doughnut",
        data: {
          labels: ["Gastos", "Sobra"],
          datasets: [{
            data: [total, Math.max(0, salarioFixo - total)],
            backgroundColor: ["#ef4444", "#22c55e"]
          }]
        }
      });
    }

    // üëâ Login an√¥nimo e inicializa√ß√£o
    signInAnonymously(auth).catch(console.error);
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        await carregarSalario();
        listarGastos();
      }
    });

    window.salvarSalario = salvarSalario;
    window.salvarGasto = salvarGasto;
    window.removerGasto = removerGasto;
  </script>
</body>
</html>
